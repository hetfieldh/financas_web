{# templates/movimento_renda/edit.html #}

{% extends 'base.html' %}

{% block title %}Finanças Web | MOV Folha{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-auto border border-gray-200">
    <h2 class="text-3xl font-semibold text-gray-900 mb-6 text-center">Editar Item de Rendimento</h2>
    <form method="POST" action="{{ url_for('movimento_renda.edit_movimento_renda', movimento_id=movimento.id) }}">
        <div class="mb-5">
            <label for="renda_id" class="block text-gray-700 text-sm font-medium mb-2">Renda</label>
            <select id="renda_id" name="renda_id" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                {% for renda in rendas %}
                <option value="{{ renda.id }}" data-tipo="{{ renda.tipo }}" {% if renda.id==movimento.renda_id
                    %}selected{% endif %}>
                    {{ renda.descricao }} ({{ renda.tipo }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-5">
            <label for="mes_ref" class="block text-gray-700 text-sm font-medium mb-2">Mês/Ano de Referência</label>
            <input type="month" id="mes_ref" name="mes_ref" value="{{ mes_ref_month_year }}" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
        </div>
        <div class="mb-5">
            <label for="mes_pagto" class="block text-gray-700 text-sm font-medium mb-2">Mês/Ano do Pagamento</label>
            <input type="month" id="mes_pagto" name="mes_pagto" value="{{ mes_pagto_month_year }}" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
        </div>
        <div class="mb-6">
            <label for="valor_display" class="block text-gray-700 text-sm font-medium mb-2">Valor (R$)</label>
            <input type="text" id="valor_display" value="{{ movimento.valor | float }}" required inputmode="decimal"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                placeholder="Ex: 2500,00">
            <input type="hidden" id="valor_hidden" name="valor" value="{{ movimento.valor | float }}">
            <p id="valor-validation-message" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('movimento_renda.list_movimentos_renda') }}"
                class="inline-flex items-center px-6 py-2 border border-gray-300 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                Cancelar
            </a>
            <button type="submit"
                class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                <i class="fas fa-save mr-2"></i> Salvar Alterações
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rendaSelect = document.getElementById('renda_id');
        const valorDisplayInput = document.getElementById('valor_display');
        const valorHiddenInput = document.getElementById('valor_hidden');
        const valorValidationMessage = document.getElementById('valor-validation-message');

        function formatDisplayValue(number) {
            if (isNaN(number)) return '';
            let formatted = parseFloat(number).toFixed(2).replace('.', ',');
            return formatted.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseDisplayValue(valueString) {
            if (!valueString) return NaN;
            valueString = valueString.trim();
            valueString = valueString.replace(/\./g, '');
            valueString = valueString.replace(/,/g, '.');
            return parseFloat(valueString);
        }

        function filterInput(inputElement) {
            let value = inputElement.value;
            let filteredValue = value.replace(/[^0-9.,-]/g, '');

            if (filteredValue.indexOf('-') > 0) {
                filteredValue = filteredValue.replace(/-/g, '');
                if (value.startsWith('-')) {
                    filteredValue = '-' + filteredValue;
                }
            }

            const decimalSeparator = filteredValue.includes(',') ? ',' : filteredValue.includes('.') ? '.' : null;
            if (decimalSeparator) {
                const parts = filteredValue.split(decimalSeparator);
                if (parts.length > 2) {
                    filteredValue = parts[0] + decimalSeparator + parts.slice(1).join('');
                }
            }
            inputElement.value = filteredValue;
        }

        function getSelectedRendaType() {
            const selectedOption = rendaSelect.options[rendaSelect.selectedIndex];
            return selectedOption ? selectedOption.dataset.tipo : null;
        }

        function validateAndAdjustValor() {
            let numericValue = parseDisplayValue(valorDisplayInput.value);
            const rendaType = getSelectedRendaType();

            valorValidationMessage.classList.add('hidden');
            valorDisplayInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');

            if (isNaN(numericValue) || valorDisplayInput.value.trim() === '') {
                if (valorDisplayInput.value.trim() !== '') {
                    valorValidationMessage.textContent = 'Por favor, insira um valor numérico válido (ex: 2.500,00).';
                    valorValidationMessage.classList.remove('hidden');
                    valorDisplayInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                }
                valorHiddenInput.value = '0.00';
                return;
            }

            if (rendaType === 'Imposto' || rendaType === 'Desconto') {
                if (numericValue > 0) {
                    numericValue = -numericValue;
                    flashMessage('O valor para este tipo de renda deve ser negativo e foi ajustado.', 'info');
                }
            } else {
                if (numericValue < 0) {
                    numericValue = Math.abs(numericValue);
                    flashMessage('O valor para este tipo de renda deve ser positivo e foi ajustado.', 'info');
                }
            }

            if (numericValue === 0 && (rendaType !== 'Imposto' && rendaType !== 'Desconto')) {
                valorValidationMessage.textContent = 'O valor da renda deve ser positivo.';
                valorValidationMessage.classList.remove('hidden');
                valorDisplayInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            }
            valorDisplayInput.value = formatDisplayValue(numericValue);
            valorHiddenInput.value = numericValue.toFixed(2);
        }

        function flashMessage(message, type) {
            console.log(`Flash (${type}): ${message}`);
        }

        valorDisplayInput.addEventListener('input', function () {
            filterInput(this);
        });

        valorDisplayInput.addEventListener('blur', validateAndAdjustValor);
        rendaSelect.addEventListener('change', validateAndAdjustValor);

        valorDisplayInput.addEventListener('focus', function () {
            const currentNumericValue = parseDisplayValue(this.value);
            if (!isNaN(currentNumericValue)) {
                this.value = currentNumericValue.toString();
            } else {
                this.value = '';
            }
            valorValidationMessage.classList.add('hidden');
            valorDisplayInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        });

        const initialValue = parseFloat(valorDisplayInput.value);
        if (!isNaN(initialValue)) {
            valorDisplayInput.value = formatDisplayValue(initialValue);
            valorHiddenInput.value = initialValue.toFixed(2);
        } else {
            valorDisplayInput.value = formatDisplayValue(0);
            valorHiddenInput.value = '0.00';
        }
        validateAndAdjustValor();
    });
</script>
{% endblock %}