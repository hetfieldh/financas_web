{# templates\movimento_crediario\edit.html #}

{% extends 'base.html' %}

{% block title %}Finanças Web | MOV Crediário{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-auto border border-gray-200">
    <h2 class="text-3xl font-semibold text-gray-900 mb-6 text-center">Editar Movimento de Crediário</h2>
    <form method="POST"
        action="{{ url_for('movimento_crediario.edit_movimento_crediario', movimento_id=movimento.id) }}">
        <script type="application/json" id="grupos-crediario-data">
            {{ grupos_crediario_json_data | safe }}
        </script>
        <div class="mb-5">
            <label for="grupo_crediario_id" class="block text-gray-700 text-sm font-medium mb-2">Grupo de
                Crediário</label>
            <select id="grupo_crediario_id" name="grupo_crediario_id" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                {% for grupo in grupos_crediario %}
                <option value="{{ grupo.id }}" {% if grupo.id==movimento.grupo_crediario_id %}selected{% endif %}>{{
                    grupo.grupo }} ({{ grupo.tipo }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-5">
            <label for="crediario_id" class="block text-gray-700 text-sm font-medium mb-2">Crediário</label>
            <select id="crediario_id" name="crediario_id" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                {% for crediario in crediarios %}
                <option value="{{ crediario.id }}" {% if crediario.id==movimento.crediario_id %}selected{% endif %}>{{
                    crediario.crediario }} (Final: {{ crediario.final }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-5">
            <label for="data_compra" class="block text-gray-700 text-sm font-medium mb-2">Data da Compra</label>
            <input type="date" id="data_compra" name="data_compra" value="{{ data_compra_str }}" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
        </div>
        <div class="mb-5">
            <label for="descricao" class="block text-gray-700 text-sm font-medium mb-2">Descrição</label>
            <input type="text" id="descricao" name="descricao" value="{{ movimento.descricao }}" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                placeholder="Ex: Compra de Eletrônico, Serviço de Manutenção">
        </div>
        <div class="mb-5">
            <label for="valor_total_display" class="block text-gray-700 text-sm font-medium mb-2">Valor Total
                (R$)</label>
            <input type="text" id="valor_total_display" value="{{ '%.2f' | format(movimento.valor_total | float) }}"
                required inputmode="decimal"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                placeholder="Ex: 1500,00 ou -50,00">
            <input type="hidden" id="valor_total_hidden" name="valor_total"
                value="{{ '%.2f' | format(movimento.valor_total | float) }}">
            <p id="valor-validation-message" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>
        <div class="mb-5">
            <label for="num_parcelas" class="block text-gray-700 text-sm font-medium mb-2">Número de Parcelas
                (1-360)</label>
            <input type="number" id="num_parcelas" name="num_parcelas" value="{{ movimento.num_parcelas }}" required
                min="1" max="360"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                placeholder="Ex: 12">
        </div>
        <div class="mb-6">
            <label for="primeira_parcela" class="block text-gray-700 text-sm font-medium mb-2">Mês/Ano da Primeira
                Parcela</label>
            <input type="month" id="primeira_parcela" name="primeira_parcela" value="{{ primeira_parcela_month_year }}"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
        </div>

        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('movimento_crediario.list_movimentos_crediario') }}"
                class="inline-flex items-center px-6 py-2 border border-gray-300 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                Cancelar
            </a>
            <button type="submit"
                class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                <i class="fas fa-save mr-2"></i> Salvar Alterações
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const valorTotalDisplayInput = document.getElementById('valor_total_display');
        const valorTotalHiddenInput = document.getElementById('valor_total_hidden');
        const grupoCrediarioIdSelect = document.getElementById('grupo_crediario_id');
        const valorValidationMessage = document.getElementById('valor-validation-message');

        function padBase64(base64) {
            const padding = base64.length % 4;
            if (padding === 0) {
                return base64;
            }
            return base64 + '='.repeat(4 - padding);
        }

        const jsonScriptTag = document.getElementById('grupos-crediario-data');
        let gruposCrediarioData = [];
        if (jsonScriptTag && jsonScriptTag.textContent) {
            try {
                let base64StringRaw = jsonScriptTag.textContent;
                const base64StringNoWhitespace = base64StringRaw.replace(/\s/g, '');
                const base64StringClean = base64StringNoWhitespace.replace(/[^A-Za-z0-9+/=]/g, '');
                const base64StringPadded = padBase64(base64StringClean);

                if (base64StringPadded) {
                    const jsonString = atob(base64StringPadded);
                    gruposCrediarioData = JSON.parse(jsonString);
                } else {
                    console.warn('Base64 string is empty after cleaning and padding. No data to parse (edit.html).');
                    gruposCrediarioData = [];
                }
            } catch (e) {
                console.error('Erro ao analisar JSON de grupos de crediário (edit.html):', e, 'String Base64 limpa e preenchida:', base64StringPadded);
                gruposCrediarioData = [];
            }
        }

        const gruposCrediarioMap = {};
        gruposCrediarioData.forEach(item => {
            gruposCrediarioMap[item.id] = { grupo: item.grupo, tipo: item.tipo };
        });

        function formatDisplayValue(number) {
            if (isNaN(number)) return '';
            return parseFloat(number).toFixed(2).replace('.', ',');
        }

        function parseDisplayValue(valueString) {
            if (!valueString) return NaN;
            valueString = valueString.trim();
            valueString = valueString.replace(/\./g, '');
            valueString = valueString.replace(/,/g, '.');
            return parseFloat(valueString);
        }

        function filterInput(inputElement) {
            let value = inputElement.value;
            let filteredValue = value.replace(/[^0-9.,-]/g, '');

            if (filteredValue.indexOf('-') > 0) {
                filteredValue = filteredValue.replace(/-/g, '');
                if (value.startsWith('-')) {
                    filteredValue = '-' + filteredValue;
                }
            }
            inputElement.value = filteredValue;
        }

        function validateAndAdjustValor() {
            let numericValue = parseDisplayValue(valorTotalDisplayInput.value);

            const selectedGrupoId = grupoCrediarioIdSelect.value;
            let grupoTipo = null;

            if (selectedGrupoId && gruposCrediarioMap[selectedGrupoId]) {
                grupoTipo = gruposCrediarioMap[selectedGrupoId].tipo;
            }

            valorValidationMessage.classList.add('hidden');
            valorTotalDisplayInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');

            if (isNaN(numericValue)) {
                if (valorTotalDisplayInput.value !== '' && valorTotalDisplayInput.value !== '-') {
                    valorValidationMessage.textContent = 'Por favor, insira um valor numérico válido (ex: 1.500,75 ou -50,00).';
                    valorValidationMessage.classList.remove('hidden');
                    valorTotalDisplayInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                }
                valorTotalHiddenInput.value = '0.00';
                return;
            }

            if (grupoTipo === 'Compra' && numericValue < 0) {
                numericValue = Math.abs(numericValue);
                valorValidationMessage.textContent = 'Para Grupos de Crediário do tipo "Compra", o valor deve ser positivo. Valor ajustado.';
                valorValidationMessage.classList.remove('hidden');
                valorTotalDisplayInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            } else if (grupoTipo === 'Estorno' && numericValue > 0) {
                numericValue = -Math.abs(numericValue);
                valorValidationMessage.textContent = 'Para Grupos de Crediário do tipo "Estorno", o valor deve ser negativo. Valor ajustado.';
                valorValidationMessage.classList.remove('hidden');
                valorTotalDisplayInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            }

            valorTotalDisplayInput.value = formatDisplayValue(numericValue);
            valorTotalHiddenInput.value = numericValue.toFixed(2);
        }

        valorTotalDisplayInput.addEventListener('input', function () {
            filterInput(this);
        });

        valorTotalDisplayInput.addEventListener('blur', validateAndAdjustValor);

        valorTotalDisplayInput.addEventListener('focus', function () {
            const currentNumericValue = parseDisplayValue(this.value);
            if (!isNaN(currentNumericValue)) {
                this.value = currentNumericValue.toString();
            } else {
                this.value = '';
            }
            valorValidationMessage.classList.add('hidden');
            valorTotalDisplayInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        });

        grupoCrediarioIdSelect.addEventListener('change', function () {
            validateAndAdjustValor();
        });

        validateAndAdjustValor();
    });
</script>
{% endblock %}