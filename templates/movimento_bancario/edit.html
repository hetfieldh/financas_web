{% extends 'base.html' %}

{% block title %}Editar Movimento Bancário - Finanças Web{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-auto border border-gray-200">
    <h2 class="text-3xl font-semibold text-gray-900 mb-6 text-center">Editar Movimento Bancário</h2>
    <form method="POST" action="{{ url_for('movimento_bancario.edit_movimento', movimento_id=movimento.id) }}"
        data-transacoes-json="{{ transacoes_json_data | safe }}"> {# ATENÇÃO: Usar | safe para inserir string JSON
        diretamente #}
        <div class="mb-5">
            <label for="conta_bancaria_id" class="block text-gray-700 text-sm font-medium mb-2">Conta Bancária</label>
            <select id="conta_bancaria_id" name="conta_bancaria_id" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                <option value="">Selecione uma conta...</option>
                {% for conta in contas %}
                <option value="{{ conta.id }}" {% if conta.id==movimento.conta_bancaria_id %}selected{% endif %}>
                    {{ conta.banco }} - Ag: {{ conta.agencia }} C: {{ conta.conta }} ({{ conta.tipo }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-5">
            <label for="transacao_bancaria_id" class="block text-gray-700 text-sm font-medium mb-2">Tipo de
                Transação</label>
            <select id="transacao_bancaria_id" name="transacao_bancaria_id" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                <option value="">Selecione um tipo de transação...</option>
                {% for transacao_item in transacoes %} {# Renomeado para evitar conflito com 'transacao' objeto do
                movimento #}
                <option value="{{ transacao_item.id }}" {% if transacao_item.id==movimento.transacao_bancaria_id
                    %}selected{% endif %}>
                    {{ transacao_item.transacao }} ({{ transacao_item.tipo }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-5">
            <label for="data" class="block text-gray-700 text-sm font-medium mb-2">Data</label>
            <input type="date" id="data" name="data" required value="{{ movimento.data.strftime('%Y-%m-%d') }}"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
        </div>
        <div class="mb-5">
            <label for="valor" class="block text-gray-700 text-sm font-medium mb-2">Valor (R$)</label>
            <input type="text" id="valor" name="valor" value="{{ '%.2f' | format(movimento.valor | float) }}"
                inputmode="decimal" {# Permite o sinal negativo #}
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                placeholder="Ex: 150.75 ou -50.00">
            <p id="valor-validation-message" class="text-red-500 text-xs mt-1 hidden"></p> {# Mensagem de validação #}
        </div>
        <div class="mb-6">
            <label for="tipo_movimento_display" class="block text-gray-700 text-sm font-medium mb-2">Tipo de
                Movimento</label>
            {# O campo de tipo de movimento agora é somente leitura #}
            <input type="text" id="tipo_movimento_display" name="tipo" readonly value="{{ movimento.tipo }}" {# Valor
                inicial do movimento existente #}
                class="w-full px-4 py-2 border border-gray-300 bg-gray-100 rounded-lg focus:outline-none cursor-not-allowed">
            <input type="hidden" name="tipo_hidden" id="tipo_hidden" value="{{ movimento.tipo }}"> {# Campo oculto para
            submeter o valor real #}
        </div>
        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('movimento_bancario.list_movimentos') }}"
                class="inline-flex items-center px-6 py-2 border border-gray-300 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                Cancelar
            </a>
            <button type="submit"
                class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                <i class="fas fa-save mr-2"></i> Salvar Alterações
            </button>
        </div>
    </form>
</div>

<!-- Script para validar e ajustar valores e tipo de movimento -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const valorInput = document.getElementById('valor');
        const tipoMovimentoDisplay = document.getElementById('tipo_movimento_display');
        const tipoMovimentoHidden = document.getElementById('tipo_hidden');
        const transacaoBancariaIdSelect = document.getElementById('transacao_bancaria_id');
        const form = document.querySelector('form');
        const valorValidationMessage = document.getElementById('valor-validation-message');

        let transacoesData = [];
        try {
            const jsonString = form.getAttribute('data-transacoes-json');
            if (jsonString) {
                transacoesData = JSON.parse(jsonString.trim()); // Adicionado .trim()
            }
        } catch (e) {
            console.error('Erro ao analisar JSON de transações:', e);
        }

        const transactionTypesMap = {};
        transacoesData.forEach(item => {
            transactionTypesMap[item.id] = { transacao: item.transacao, tipo: item.tipo };
        });

        // Formata um valor numérico para a moeda local (pt-BR)
        function formatCurrency(value) {
            if (isNaN(value)) {
                return '';
            }
            return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Limpa e analisa o valor do input para um n\u00famero float
        function parseFormattedValue(value) {
            const normalizedValue = value.replace(',', '.'); // Substitui v\u00edrgula por ponto para parseFloat
            return parseFloat(normalizedValue);
        }

        // Fun\u00e7\u00e3o para filtrar a entrada do utilizador em tempo real (menos agressiva)
        function filterInput(inputElement) {
            let value = inputElement.value;
            // Permite apenas d\u00edgitos, v\u00edrgula, ponto e sinal de menos
            let filteredValue = value.replace(/[^0-9,.-]/g, '');

            // Garante que o sinal de menos s\u00f3 aparece no in\u00edcio
            if (filteredValue.indexOf('-') > 0) {
                filteredValue = filteredValue.replace(/-/g, '');
                if (value.startsWith('-')) { // Se o original tinha '-', mant\u00e9m no in\u00edcio
                    filteredValue = '-' + filteredValue;
                }
            }

            // Garante apenas um separador decimal e normaliza para ponto
            const parts = filteredValue.split(/[.,]/);
            if (parts.length > 2) {
                // Se h\u00e1 mais de um separador, considera apenas o primeiro
                filteredValue = parts[0] + '.' + parts.slice(1).join('').replace(/[.,]/g, '');
            } else if (parts.length === 2) {
                filteredValue = parts[0] + '.' + parts[1]; // Normaliza para ponto
            }
            // N\u00e3o limita casas decimais aqui, para permitir digita\u00e7\u00e3o livre

            inputElement.value = filteredValue; // Atualiza o valor do input com o valor filtrado
        }


        // Valida o valor para o tipo de transa\u00e7\u00e3o selecionado e ajusta o tipo de movimento
        function validateValueForType() {
            // N\u00e3o chamamos filterInput aqui, pois ele j\u00e1 \u00e9 chamado no event listener 'input'
            let valorNumerico = parseFormattedValue(valorInput.value);

            const selectedTransacaoId = transacaoBancariaIdSelect.value;
            let transacaoTipo = null;

            if (selectedTransacaoId && transactionTypesMap[selectedTransacaoId]) {
                transacaoTipo = transactionTypesMap[selectedTransacaoId].tipo;
            }

            valorValidationMessage.classList.add('hidden'); // Esconde a mensagem por padr\u00e3o
            valorInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500'); // Remove borda vermelha

            if (isNaN(valorNumerico) && valorInput.value !== '' && valorInput.value !== '-') {
                valorValidationMessage.textContent = 'Por favor, insira um valor numérico válido (ex: 123,45 ou -10,00).';
                valorValidationMessage.classList.remove('hidden');
                valorInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            } else if (!isNaN(valorNumerico)) {
                if (transacaoTipo === 'Crédito' && valorNumerico < 0) {
                    valorValidationMessage.textContent = 'Para transações de Crédito, o valor deve ser positivo.';
                    valorValidationMessage.classList.remove('hidden');
                    valorInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                } else if (transacaoTipo === 'Débito' && valorNumerico > 0) {
                    valorValidationMessage.textContent = 'Para transações de Débito, o valor deve ser negativo.';
                    valorValidationMessage.classList.remove('hidden');
                    valorInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                }
            }

            // Ajusta o tipo de movimento com base no tipo de transa\u00e7\u00e3o ou no sinal do valor
            if (transacaoTipo === 'Crédito') {
                adjustTipoMovimento('Receita');
            } else if (transacaoTipo === 'Débito') {
                adjustTipoMovimento('Despesa');
            } else {
                adjustTipoMovimento(); // Ajusta com base no sinal atual do valor
            }
        }

        // Fun\u00e7\u00e3o para ajustar o tipo de movimento (Receita/Despesa)
        function adjustTipoMovimento(forcedType = null) {
            if (forcedType) {
                tipoMovimentoDisplay.value = forcedType;
                tipoMovimentoHidden.value = forcedType;
            } else {
                const valorNumerico = parseFormattedValue(valorInput.value);
                if (!isNaN(valorNumerico)) {
                    tipoMovimentoDisplay.value = valorNumerico >= 0 ? 'Receita' : 'Despesa';
                    tipoMovimentoHidden.value = valorNumerico >= 0 ? 'Receita' : 'Despesa';
                } else {
                    // Padr\u00e3o se o valor n\u00e3o for num\u00e9rico (ex: vazio ou apenas '-')
                    tipoMovimentoDisplay.value = 'Receita';
                    tipoMovimentoHidden.value = 'Receita';
                }
            }
        }

        // Adiciona event listener para o campo de valor no evento 'input' (a cada tecla digitada)
        valorInput.addEventListener('input', function () {
            filterInput(this); // Filtra caracteres indesejados
            validateValueForType(); // Valida e ajusta o tipo de movimento
        });

        // Adiciona event listener para o campo de valor no evento 'blur' (ao sair do campo)
        valorInput.addEventListener('blur', function () {
            filterInput(this); // Uma \u00faltima filtragem para garantir

            let valorNumerico = parseFormattedValue(this.value);
            const selectedTransacaoId = transacaoBancariaIdSelect.value;
            let transacaoTipo = null;

            if (selectedTransacaoId && transactionTypesMap[selectedTransacaoId]) {
                transacaoTipo = transactionTypesMap[selectedTransacaoId].tipo;
            }

            // Aplica a corre\u00e7\u00e3o de sinal e formata\u00e7\u00e3o final ao sair do campo
            if (!isNaN(valorNumerico)) {
                if (transacaoTipo === 'Crédito' && valorNumerico < 0) {
                    valorNumerico = Math.abs(valorNumerico);
                } else if (transacaoTipo === 'Débito' && valorNumerico > 0) {
                    valorNumerico = -Math.abs(valorNumerico);
                }
                this.value = formatCurrency(valorNumerico);
            } else if (this.value === '' || this.value === '-') {
                // Se o campo estiver vazio ou apenas com "-", zera e formata
                this.value = formatCurrency(0);
            } else {
                // Para valores inv\u00e1lidos que n\u00e3o s\u00e3o vazio/\u00faltimo "-", limpa o campo
                this.value = '';
            }
            validateValueForType(); // Re-valida para garantir que as mensagens est\u00e3o corretas ap\u00f3s o blur
        });

        // Adiciona event listener para o campo de tipo de transa\u00e7\u00e3o no evento 'change'
        transacaoBancariaIdSelect.addEventListener('change', function () {
            validateValueForType(); // Re-valida o valor atual para o novo tipo de transa\u00e7\u00e3o
            valorInput.dispatchEvent(new Event('blur')); // Simula o blur no campo valor para re-formatar
        });

        // Chama as fun\u00e7\u00f5es ao carregar a p\u00e1gina para definir os valores iniciais e validar
        // Isso \u00e9 importante especialmente para o modo de edi\u00e7\u00e3o
        valorInput.dispatchEvent(new Event('blur')); // Simula o blur para inicializar a formata\u00e7\u00e3o inicial
        validateValueForType();
    });
</script>
{% endblock %}